SHELL := bash
.ONESHELL:
.SHELLFLAGS := -eu -o pipefail -c
.DELETE_ON_ERROR:
MAKEFLAGS += --warn-undefined-variables
MAKEFLAGS += --no-builtin-rules

##--------------------------------------------##

# SRR number to download reads
SRR=SRR28572035

# Number of reads to download
N=10000

# Downloaded read names
R1=reads/${SRR}_1.fastq
R2=reads/${SRR}_2.fastq

# Trimmed read names
T1=reads/${SRR}_1.trimmed.fastq
T2=reads/${SRR}_2.trimmed.fastq

# The reads directory
RDIR=reads

# The reports directory
PDIR=reports

# The accession number of the genome

ACC=GCF_004799605.1

# The name of the genome file
GENOME= Halobacterium.fa

# Sequencing depth
DEPTH=10

# Prefix for the simulated reads
PREFIX=simulate/pbsim

# Simulated Read Names
RR1=${PREFIX}_0001.fastq
RR2=${PREFIX}_0002.fastq

# The location of the data error model
MODEL_URL=https://raw.githubusercontent.com/yukiteruono/pbsim3/refs/heads/master/data/QSHMM-RSII.model

# The name of the error model file locally.
MODEL=QSHMM-RSII.model

##--------------------------------------------##

usage:
	@echo "Usage: make [target]"
	@echo ""
	@echo "Targets:"
	@echo "  directories: Create the directories for the data"
	@echo "  download: Download the SRR data and run fastqc"
	@echo "  trim: Trim the reads and run fastqc"
	@echo "  genome: Download the genome and unzip the data"
	@echo "  simulate: Download the data error model and simulate reads"
	@echo "  index: Index the genome for alignment"
	@echo "  align: Align the reads to the genome"
	@echo "  stats: Generate alignment statistics"
	@echo "  all: Run all targets"
	@echo "  clean: Remove all files generated by this Makefile"

directories:
	mkdir -p ${RDIR} ${PDIR}

download:
	# Download the SRR data
	fastq-dump --split-files -X ${N} -O ${RDIR} ${SRR}

	# Run fastqc
	fastqc -q -o ${PDIR} ${R1} ${R2}

trim:
	# Run fastp and trim for quality
	fastp --cut_right -f 30 -F 30 -T 80 -i ${R1} -I ${R2} -o ${T1} -O ${T2}

	# Run fastqc
	fastqc -q -o ${PDIR} ${T1} ${T2}

genome:
	# Download fasta file from NCBI
	datasets download genome accession ${ACC} 

	# Unzip the data (Overwrite files if they already exist)
	unzip -o ncbi_dataset.zip

	# Make a link to a simpler name
	ln -s ncbi_dataset/data/GCF_004799605.1/GCF_004799605.1_ASM479960v1_genomic.fna Halobacterium.fa

simulate:
	# Download the data error model
	wget -nc ${MODEL_URL}

	# Make the reads directory
	mkdir -p ${PREFIX}

	# Run the simulation
	pbsim  --strategy wgs --method qshmm --qshmm ${MODEL} --depth ${DEPTH} --genome ${GENOME} --prefix ${PREFIX}

	# Statistics on the simulated reads.
	seqkit stats ${RR1} ${RR2}

index:
	# Index the genome for alignment
	bwa index ${GENOME}	

align:
	# Make the bam directory
	mkdir -p bam

	# Align the downloaded reads to the genome
	bwa mem ${GENOME} ${R1} ${R2} | samtools sort -o bam/downloaded.bam

	# Index the bam file
	samtools index bam/downloaded.bam

	# Align the first set of simulated reads to the genome
	bwa mem ${GENOME} ${RR1} | samtools sort -o bam/simulated_1.bam

	# Index the bam file for the first set of simulated reads
	samtools index bam/simulated_1.bam

	# Align the second set of simulated reads to the genome
	bwa mem ${GENOME} ${RR2} | samtools sort -o bam/simulated_2.bam

	# Index the bam file for the second set of simulated reads
	samtools index bam/simulated_2.bam

	# Merge the two sets of simulated reads
	samtools merge bam/simulated.bam bam/simulated_1.bam bam/simulated_2.bam

	# Index the merged bam file
	samtools index bam/simulated.bam

stats:
	# Generate alignment statistics
	samtools flagstat bam/downloaded.bam > bam/downloaded.flagstat
	samtools flagstat bam/simulated.bam > bam/simulated.flagstat

all: directories download trim genome simulate index align stats

clean:
	rm -rf ${RDIR} ${PDIR} ${GENOME} ${MODEL} ncbi_dataset.zip Halobacterium.fa QSHMM-RSII.model fastp.json fastp.html ncbi_dataset md5sum.txt simulate README.md ${PREFIX} ${GENOME}.bwt ${GENOME}.pac ${GENOME}.ann ${GENOME}.sa ${GENOME}.amb ${GENOME}.fai ${GENOME}.dict bam 

.PHONY: clean directories download trim genome simulate all usage index align stats




